<body>
  <img src="" width="640" height="480" class="video" ></img>
  <audio autoplay src="" class="audio"></audio>
  <div class='message'></div>
  <div id="wrapper">
    <button id="start">start listening</button>
    <button id="stop">stop listening</button>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.3.0/lodash.js"></script>

  <script>
    $(function() {
      // id of distribution!!!
      var id = 100

      var $video = $('.video');
      var $audio = $('.audio');
      var socket = io();

      var latestDepict = null
      var distributionCheckId = null

      var renderVideo = function(data) {
        if (data.video) $video.attr('src', data.video);
        if (data.audio) $audio.attr('src', data.audio);
        latestDepict = new Date();
      }

      var startCheck = function () {
        latestDepict = new Date();
        distributionCheckId = setInterval(checkIsVideoBeingDistributed, 500);
      }

      var endCheck = function () {
        clearInterval(distributionCheckId);
        latestDepict = null;
        $('.message').empty();
      }

      var checkIsVideoBeingDistributed = function() {
        if (latestDepict) {
          if (new Date() - latestDepict > 2000) {
            $('.message').text('現在配信されていません');
          } else {
            $('.message').empty()
          }
        }
      }

      var startListening = function() {
        socket.emit('start listening', id);
        socket.on('stream', renderVideo);
        startCheck();
      }

      var stopListening = function() {
        socket.emit('stop listening', id);
        socket.removeListener('stream', renderVideo);
        $video.attr('src', '');
        endCheck();
      }

      //ボタンイベント
      $("#start").click(function() {
        startListening();
      });
      $("#stop").click(function() {
        stopListening();
      });
    })
  </script>
</body>

