<body>
  <video autoplay width="640" height="480"></video>
  <canvas style="display:none;" width="320" height="240"></canvas>
  <div id="wrapper">
    <button id="start">start streaming</button>
    <button id="stop">stop streaming</button>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.3.0/lodash.js"></script>
  <script>
    $(function() {
      // id of this user!!!
      var id = 100

      var frameRate = 10;
      var video = document.querySelector('video');
      video.volume = 0;
      var canvas = document.querySelector('canvas');
      var ctx = canvas.getContext('2d');
      var videoStream = null;

      var socket = io();
      var videoStreamId = null;
      var audioStreamId = null;
      var d = null;

      var hasGetUserMedia = function() {
        return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
          navigator.mozGetUserMedia || navigator.msGetUserMedia);
      }

      var sendAudioToSocket = function(evt) {
        if (!videoStream) return false;
        var audioBlob = new Blob([evt.data], {type: 'audio/ogg'});
        var reader = new FileReader;

        reader.onload = function() {
          var blobUrl = reader.result;
          socket.emit('stream', {audio: blobUrl});
        };

        reader.readAsDataURL(audioBlob);
      }

      var sendVideoToSocket = function() {
        if (!videoStream) return false;
        ctx.drawImage(video, 0, 0);
        socket.emit('stream', {video: canvas.toDataURL('image/webp')});
      }

      var startAudioStreaming = function() {
        return audioStreamId = setInterval(() => {
          var recorder = new MediaRecorder(videoStream, {
            audioBitsPerSecond : 1280,
            mimeType : 'audio/ogg'
          });
          recorder.ondataavailable = sendAudioToSocket;
          recorder.start();
          setTimeout(() => {
            recorder.stop();
          }, 2000);
        }, 2000);
      }

      var startVideoStreaming = function() {
        return setInterval(() => {
          sendVideoToSocket();
        }, 1000 / frameRate);
      }

      var startStreaming = function() {
        video.src = window.URL.createObjectURL(videoStream);

        socket.emit('start distribution', id);
        videoStreamId = startVideoStreaming();
        audioStreamId = startAudioStreaming();
      }

      var stopStreaming = function() {
        clearInterval(videoStreamId);
        clearInterval(audioStreamId);
        socket.emit('stop distribution', id);

        _.isFunction(videoStream.stop) ? videoStream.stop() : videoStream = null;
        video.src = '#'
      }

      var startDistribution = function() {
        if (!hasGetUserMedia() || typeof(MediaRecorder) === 'undefined') {
          alert("未対応ブラウザです。");
          return false;
        }
        if (videoStream) return false;

        window.URL = window.URL || window.webkitURL;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
          navigator.mozGetUserMedia || navigator.msGetUserMedia;

        navigator.getUserMedia({video: { frameRate: frameRate, width: 320, height: 240 }, audio: true}, function(stream) {
          videoStream = stream;
          startStreaming();
        }, function(e) {
          console.log('エラー!', e);
        });
      }

      $("#start").click(function() {
        startDistribution();
      });
      $("#stop").click(function() {
        stopStreaming();
      });
      $("video").click(function() {
        snapshot();
      });
    })
  </script>
</body>
