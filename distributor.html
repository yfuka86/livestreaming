<body>
  <video autoplay width="640" height="480"></video>
  <canvas style="display:none;" width="640" height="480"></canvas>
  <div id="wrapper">
    <button id="start">start streaming</button>
    <button id="stop">stop streaming</button>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.3.0/lodash.js"></script>
  <script>
    $(function() {
      // id of this user!!!
      var id = 100

      var frameRate = 12;
      var video = document.querySelector('video');
      var canvas = document.querySelector('canvas');
      var ctx = canvas.getContext('2d');
      var videoStream = null;

      var socket = io();
      var socketStreamId = null;

      var hasGetUserMedia = function() {
        return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
          navigator.mozGetUserMedia || navigator.msGetUserMedia);
      }

      var sendToSocket = function(evt) {
        var videoBlob = new Blob([evt.data], { type: evt.data.type });
        blobUrl = window.URL.createObjectURL(videoBlob);
        socket.emit('stream', {video: blobUrl});
      }

      var startRecord = function() {
        var recorder = new MediaRecorder(videoStream);
        recorder.ondataavailable = sendToSocket;

        return socketStreamId = setInterval(() => {
          recorder.start();
          setTimeout(() => {
            recorder.stop();
          }, 1000);
        }, 1000);
      }

      var startStreaming = function() {
        video.src = window.URL.createObjectURL(videoStream);

        socket.emit('start distribution', id);
        socketStreamId = startRecord();
      }

      var stopStreaming = function() {
        clearInterval(socketStreamId);
        socket.emit('stop distribution', id);

        _.isFunction(videoStream.stop) ? videoStream.stop() : videoStream = null;
        video.src = '#'
      }

      var startDistribution = function() {
        if (!hasGetUserMedia()) {
          alert("未対応ブラウザです。");
        }

        window.URL = window.URL || window.webkitURL;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
          navigator.mozGetUserMedia || navigator.msGetUserMedia;

        navigator.getUserMedia({audio: true, video: true}, function(stream) {
          videoStream = stream;
          startStreaming();
        }, function(e) {
          console.log('エラー!', e);
        });
      }

      $("#start").click(function() {
        startDistribution();
      });
      $("#stop").click(function() {
        stopStreaming();
      });
      $("video").click(function() {
        snapshot();
      });
    })
  </script>
</body>
